\documentclass{article}
\usepackage{amsmath}
\title{ILP Formulation for Scheduler}

\date{\today}
\begin{document}

\maketitle

\section{Without Application Packing}
Given applications $1, 2, \ldots, n$, our goal is to make placement
decisions, assuming that the hardware available is heterogeneous. For now, we
assume we have $m$ machines: these $m$ machines can be of different types (for
example, machines with different generations of GPUs like K80s, P100s, and V100s).

We assume that a profiling run gives us rough performance estimates for each
of these applications (for example, we can time 100 minibatches of each application
on each hardware, or use collaborative filtering to extrapolate these
times from other measurements). The performance estimate for application $i$
on machine $j$ is represented by $a_{ij}$.

Now, let $x_{ij}$ be a float in $[0, 1]$ that represents the fraction of
iterations of application $i$ that should be run on
machine $j$. Then, we observe that the following constraints
must hold,

\begin{eqnarray}
0 \leq x_{ij} \leq 1 & \forall (i,j) \in \{1, 2, \ldots, n\} \times \{1, 2, \ldots, m\} \nonumber  \\
\sum_j x_{ij} = 1 & \forall i \in \{1, 2, \ldots, n\} \nonumber
\end{eqnarray}

Now, let $y_j$ represent the total running time of applications run on machine
$j$, and $y_{\text{max}}$ as the maximum $y_j$ (since applications run on different
machines can run concurrently).
\begin{eqnarray}
y_j = \sum_i x_{ij} \cdot a_{ij} & \forall j \in \{1, 2, \ldots, m\} \nonumber \\
y_{\text{max}} \geq y_j & \forall j \in \{1, 2, \ldots, m\} \nonumber
\end{eqnarray}

Now, we can minimize $y_{\text{max}}$ to find the allocation of applications
among different hardware devices that minimizes total execution time.

\section{With Application Packing}
The above formulation doesn't allow concurrent execution of applications
on any given machine. We can relax this restriction.

Instead of having a variable $x_{ij}$ for all combinations of application $i$
with machine $j$, we instead create a variable $x_{cj}$,
where $c$ is an application combination. Formally,
$$c \in \{1, 2, \ldots, n\} \times \{1, 2, \ldots, n\} \cup \{1, 2, \ldots, n\}$$
if we only consider combinations of up to two applications.
The performance estimate for an application combination is represented
as $a_{cj}$.

As before, $x_{cj}$ is a float in $[0, 1]$ that represents the
fraction of iterations application combination $c$ should be run on
machine $j$. Then, we observe that the following constraints must hold,

\begin{eqnarray}
0 \leq x_{cj} \leq 1 & \forall c,j \nonumber \\
\sum_{c \in C_i} \sum_j x_{cj} = 1 & \forall i \in \{1, 2, \ldots, n\} \nonumber
\end{eqnarray}

Here, $C_i$ represent all application combinations containing the application $i$.

We now define $y_j$ as,
\begin{eqnarray}
y_j = \sum_c x_{cj} \cdot a_{cj} & \forall j \in \{1, 2, \ldots, m\} \nonumber \\
\end{eqnarray}

And minimize $y_{\text{max}}$ as before.

Note that this formulation uses a total number of variables
linear in the total number of application combinations
under consideration. Can we do better? (probably)

\section{With Sharing Incentive}
The previous two formulations do not encourage sharing; that is, some users
could be worse off sharing the cluster compared to being given a $1/n$ fraction
of the $m$ machines (using time slicing).

This can be rectified by computing $z_i^{\text{avg}}$, which is the estimated
time needed to compute application $i$ assuming an equal share of resources.
Mathematically,

\begin{eqnarray}
z_i^{\text{avg}} = \dfrac{1}{n} \sum_{j=1}^m t_{ij} \nonumber
\end{eqnarray}

We can also compute $z_i$, which is the estimated time needed to compute application
$i$ assuming sharing of the cluster (with application packing). $z_i$ can be
computed as,

\begin{eqnarray}
z_i = \sum_{c \in C_i, j} x_{cj} t_{cj} f_{icj} \nonumber
\end{eqnarray}

Here, $f_{icj}$ is an estimate of the effective fraction of time application $i$
runs on machine $j$ when application combination $c$ is run (this could be estimated
when estimating $a_{cj}$).

Now, if we add the constraint
\begin{eqnarray}
z_i \leq z_i^{\text{avg}} \nonumber
\end{eqnarray}
to the Linear Programming formulation from above, we can ensure that each user
is awarded a resource allocation that is \emph{at least} as good as being given
a fair fraction of the cluster.

\end{document}
